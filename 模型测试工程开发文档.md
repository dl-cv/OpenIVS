# 模型测试工程开发文档

## 1. 目标

控制台测试工程（放在 `Test` 文件夹）：

- `DlcvCSharpTestCli`（C# / .NET Framework 4.7.2 / x64）
- `dlcv_infer_cpp_test`（C++ / VS2022 / x64）

用于自动化测试以下项目：

- 模型加载成功/失败判断
- 推理成功/失败判断
- 推理结果类别列表输出（按出现次数展开）
- 3 秒平均推理速度
- Batch 推理速度（单独字段）
- 加载/释放循环 10 次的内存增量
- 仅实例分割模型：推理 3 秒后的内存增量

默认模型目录：`Y:\测试模型`
测试 `.dvt` 模型。

## 2. 工程说明

### 2.1 C# 工程

- 工程名：`Test/DlcvCSharpTestCli`
- 入口文件：`Test/DlcvCSharpTestCli/Program.cs`
- 依赖项目：`DlcvCsharpApi`
- 关键点：
  - 推理前将图片从 BGR 转为 RGB
  - 结果中的 `Mask` 显式 `Dispose`
  - 内存采样使用 `GetProcessMemoryInfo`

### 2.2 C++ 工程

- 工程名：`Test/dlcv_infer_cpp_test`
- 入口文件：`Test/dlcv_infer_cpp_test/main.cpp`
- 依赖项目：`dlcv_infer_cpp_dll`
- 关键点：
  - 头文件通过工程依赖配置（`AdditionalIncludeDirectories`）引入，代码中使用 `#include "dlcv_infer.h"`，不使用相对路径包含
  - 使用 `GetProcessMemoryInfo` 采样私有内存与工作集
  - 中文路径图片读取使用 `fopen + imdecode`
  - 控制台输出 UTF-8

## 3. 默认测试用例映射

- `AOI-旋转框检测.dvt` -> `AOI-测试.jpg`
- `猫狗-分类.dvt` -> `猫狗-猫.jpg`
- `气球-实例分割.dvt` -> `气球.jpg`
- `气球-语义分割.dvt` -> `气球.jpg`
- `手机屏幕-实例分割.dvt` -> `手机屏幕.jpg`
- `引脚定位-目标检测.dvt` -> `引脚定位-目标检测.jpg`
- `OCR.dvt` -> `OCR-1.jpg`

## 4. 输出格式

控制台输出 markdown 表格，列如下：

- 模型
- 加载（成功/失败 + 耗时 + 增量）
- 推理（成功/失败）
- 类别列表（例如：气球，气球）
- 3秒速度
- Batch速度（单独一列，不支持显示 N/A）
- 加载释放10次增量
- 实例分割推理3秒增量

## 5. 构建与运行

1. 使用 `Release|x64` 编译 `OpenIVS.sln`
2. 分别运行：
   - `Test\DlcvCSharpTestCli\bin\x64\Release\DlcvCSharpTestCli.exe`
   - `Release\dlcv_infer_cpp_test.exe`

说明：

- 固定使用 GPU 设备（`device_id=0`）。
- 模型目录固定为 `Y:\测试模型`，不支持运行参数/环境变量覆盖（规则：目录/行为如需变更，请改代码与提交）。
- 为避免日志打断阅读：表格在所有测试执行完成后一次性输出（总表）。
