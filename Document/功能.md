# 新版 OpenIVS 软件功能定义

本文档从功能视角限定 OpenIVS 的完整能力范围与行为要求，作为实现无关的功能说明。任何实现均需达到本文描述的功能与输出一致性。

## 1. 目标与范围
- 目标：对产品进行多相机视觉检测、模版匹配与缺陷判定，输出统一的 OK/NG 结果，并实现全流程数据追溯。
- 范围：包含设备接入、触发与采集、AI 推理、模版管理与匹配、缺陷判定、结果汇总、PLC 写回、数据存储、日志与调试、UI 操作与统计。
- 不包含：模型训练与标注工具、设备驱动开发、非本机数据库服务。

## 2. 术语与核心对象
- 产品/工件：被检测的实体，一次检测对应一个产品。
- 条码：读码器输出的产品识别码。
- 产品型号：由条码映射得到的型号信息。
- 模版：某型号在某位置的标准检测目标集合（文本框、目标框及其属性）。
- 相机位置：由配置定义的位置标识，数量不固定，关联相机设备与流程/结果中的位置键。
- 画面分割：将显示区域按 2x2/3x3/4x4 网格划分，网格单元可合并为矩形区域。
- 画面区域：由一个或多个网格单元组成的矩形区域，可绑定一个相机视图。
- 任务（RunOnce）：一次完整的触发→采集→推理→匹配→汇总→输出。
- OK/NG：合格/不合格，分为内部判定与对外写回判定。
- 处理数据载体：图像数据 + 结构化结果（JSON）。
- 在线模式：使用真实相机输入，由 PLC 触发执行 RunOnce。
- 离线/测试模式：使用本地图像输入，通过 PLC 模拟器触发执行 RunOnce。

## 3. 系统边界与外部交互
- 设备输入
  - 工业相机（位置与数量可配置），支持真实设备与测试设备。
  - 读码器，支持真实设备、测试设备与 Modbus 读码。
  - 触发信号，可来自 PLC 寄存器、网络或软件触发。
- 外部服务
  - 条码查询 API（可启用或禁用）。
  - PLC 通信（Modbus TCP/RTU、FINS/UDP 等）。
- 数据落盘
  - 图像、JSON 结果、CSV 记录、系统日志。
- 底层库依赖
  - 基于原 OpenIVS 仓库底层库开发，缺失能力从 PrintMatch 移植。
  - 已有：CameraManager、DlcvCsharpApi（推理+流程模块）、ModbusApi、SimpleLogger、ImageViewer、DlcvDvpHttpApi。
  - 需移植：ICamera 接口、WPF ImageViewer、Modbus TCP/异步增强、高级日志、读码器、数据模型、推理引擎封装、模版匹配引擎。
  - 详见 `底层库与移植.md`。

## 4. 运行语义与总体流程
- 运行语义：FlowGraph = 一次任务（RunOnce），重复运行由外层循环触发，图内不自循环。
- 运行前加载与校验流程 JSON，锁定本次 RunOnce 配置版本；变更需重新加载后生效。
- 总体流程
  1. 加载并校验流程 JSON，准备任务上下文。
  2. 触发开始一次任务（如启用运动控制则先完成移动并等待稳定）。
  3. 读码器读取条码并获取产品型号。
  4. 相机按配置顺序串行采集图像（避免网络丢包）。
  5. 各面图像进入推理流程，生成检测结果。
  6. 配置的模版匹配位置执行模版匹配与缺陷检测，其他位置执行各自的检测与判定。
  7. 汇总各相机位置结果，得到最终 OK/NG。
  8. 保存图像、JSON、CSV、日志并向 PLC 写回。
- 离线/测试模式使用本地图像输入，触发仍走 PLC 信号链路（可用模拟器）。

## 5. 功能模块

### 5.1 触发与任务调度
- 支持软触发与硬触发。
- 支持 PLC 拍照信号监听：检测寄存器边沿变化后自动触发任务。
- 启用监听时，按设置的轮询间隔读取寄存器，检测 0→1 上升沿触发；流程运行中不触发。
- 支持手动触发（拍照/调试入口）。

### 5.2 相机采集
- 支持多路相机，数量与位置由配置决定；每路可配置为真实设备或测试图片。
- 相机位置与画面区域绑定，位置标识用于流程配置、落盘与结果字段。
- 支持每路相机旋转角度配置（0/90/180/270）。
- 采集与推理采用流水线调度：取图按配置顺序串行，每路取图完成后立即启动该位置的推理（不阻塞后续取图），多路推理并行执行。详见 `流程图.md` 中"采集与推理的流水线调度"。
- 每路相机输出图像与对应结果通道，用于后续推理与显示。

### 5.3 读码与条码处理
- 读码器模式：真实设备、测试设备、Modbus 读码。
- Modbus 读码按设置的寄存器地址与数量读取保持寄存器，按 ASCII 高字节在前拼接并裁剪空字符。
- 触发模式随系统设置切换（软触发或连续模式）。
- 支持无条码检测与处理策略配置。

### 5.4 产品型号解析
- 支持条码 API 查询产品型号，可配置启用、地址与超时。
- API 协议：POST 请求，body 为 `{"barcode":"xxx"}`，Content-Type: application/json；响应解析 `data[0].maktx` 字段作为产品型号；超时通过 CancellationToken 控制，最低 1 秒。
- 支持本地条码→型号映射表作为降级方案；映射表应支持在设置界面编辑与持久化。
- API 异常或超时时自动降级为本地映射；本地映射无结果时返回 Unknown。

### 5.5 AI 推理与流程配置
- 流程图分两级：主流程图（触发/采集/读码/判定/输出等）和推理子图（AI 推理链路），均由流程图编辑器拖拽生成 JSON。
- 运行时以主流程 JSON 为入口，主流程中的 `inference/subgraph` 节点引用推理子图 JSON，双击可打开子图编辑器。
- 支持按相机位置配置推理流程与模块链路。
- 模块类型支持：检测、OCR、分类、分割、缺陷检测、后处理。
- 模块角色支持：模版匹配角色与缺陷判定角色。
- 支持按流程 JSON 配置推理节点，并提供节点级参数覆盖。
- 运行以流程 JSON 为准，加载失败不得进入运行。
- 推理数据采用"图像 + JSON"统一载体，便于模块级联。
- 推理子图的 ocr_results 生成：推理链路最终输出的 sample_results[].results[] 中，将 recognized_text（或 classification_label/category_name）与 bbox 提取为 ocr_results[]，用于后续模版匹配。

#### 5.5.1 模型与推理细则
- 模型格式/框架：DLCV 推理引擎，模型文件支持 `.dvt/.dvo`（本地 DLL 推理）与 `.dvp`（DVP 服务推理）；`.dvp` 通过本地 HTTP 服务 `/load_model`、`/api/inference`、`/get_model_info`、`/version`。
- 输入/归一化/颜色空间：输入 Mat 默认 BGR，推理前统一 BGR→RGB；单通道输入转 BGR；输入尺寸与归一化参数由模型自身配置；OCR/分类 ROI 直接从原图裁剪（含旋转框）。
- 输出字段/标签映射：统一输出 `sample_results[].results[]`，字段 `category_id/category_name/score/area/bbox/with_bbox/with_mask/mask/with_angle/angle`；DVP 原始 bbox 为 `[x1,y1,x2,y2]`，业务侧统一为 `[x,y,w,h]`；OCR 输出 `recognized_text/text_confidence/text_region/ready_for_recognition/text_processed`；分类输出 `classification_label/classification_score`；缺陷输出 `width/height/aspect_ratio/size_valid/is_ok_category`；文本类别默认集合 `文本/文字/文本-OK/文本2`。
- 后处理默认阈值：PostProcessing `length=50`、`width=50`、`area=100`、`score=0.5`；文本置信度提醒阈值 0.8；缺陷尺寸判定默认长/宽阈值 50；缝隙检测默认 `GapLengthThreshold=50`、`GapWidthThreshold=50`。
- 版本与热更新：模型版本以文件名 + `GetModelInfo()` 返回为准；`.dvp` 模式加载后调用 `/version` 记录服务版本；设置界面修改模型路径、模块绑定或流程 JSON 覆盖后重建管道并清空模型缓存（`ClearModelCache`），新模型在下次 RunOnce 生效。

### 5.6 模版管理
- 支持创建、查看、更新、删除模版。
- 模版关联产品型号与相机位置，并保存参考图像与检测框信息。
- 支持从当前检测结果生成模版。
- 支持 Unknown 模版策略：
  - 禁用历史：仅本次运行有效，不落盘、不加载历史。
  - 启用历史：允许持久化与加载历史 Unknown 模版。
- 模版数据结构与匹配字段详见 5.6.1 与 5.7.1。

#### 5.6.1 模版文件结构与存储规范
- 模版根目录：优先使用设置 `TemplatesPath`；为空时使用 `ImageSaveConfig.SavePath/模版`；流程模块运行时如提供 `templates_dir` 则使用该目录并确保为绝对路径。
- 文件组成：`{TemplateId}.json` + `{TemplateId}.png`（可选参考图）；`image_path` 仅保存文件名以便迁移。
- TemplateId 规则：以产品型号为主（为空则用模版名），转为安全文件名并追加相机位置后缀 `_{position_id}`；非法字符替换为 `_`，空值回退为 `Unknown`。
- JSON 字段（模版对象）：
  - `template_id/template_name/product_id/product_name/camera_position/created_time/updated_time/is_enabled/image_path`
  - `ocr_results[]`：`text/x/y/width/height/confidence/recognition_time/match_status`
  - 兼容字段：`expected_x/expected_y/expected_width/expected_height/expected_text/position_tolerance/size_tolerance/min_confidence/strict_text_match`
- 落盘过滤：OCR 项中 `text` 以 `NG-` 开头或 `-NG` 结尾的条目不写入模版文件，其余保持原样。

#### 5.6.2 坐标系与标定/畸变校正
- 坐标系基准：模版与 OCR 框均使用原图坐标系，原点在左上角，x 向右，y 向下，单位为像素。
- 结果坐标回映射：若推理链路包含裁剪/缩放/旋转等变换，需通过变换链路（仿射 2x3）反变换到原图坐标再入模版。
- 旋转框处理：当模型输出 `with_angle` 时，先按中心点/宽高/角度得到四角点，再取外接轴对齐矩形写入模版。
- 标定/畸变：旧版本未内置镜头畸变校正；如需校正应作为前处理步骤执行，并同步更新变换链路以保证回映射一致。

#### 5.6.3 模版生成/更新权限约束
- 创建条件：必须有有效条码与产品型号；条码为空/NG/Local 或型号为空/Unknown 时禁止创建。
- 重复约束：同型号同位置唯一；发现重复需用户确认替换，替换时先删除旧模版再保存。
- 更新规则：更新时保持 TemplateId 为 `安全型号_相机位置`；若不一致则删除旧文件并重新创建。
- 批量生成：从一次完整结果可按已配置的位置批量生成模版。

### 5.7 模版匹配逻辑
- 文本为空的模版项与检测项均忽略；低于最小置信度阈值的检测项过滤。
- 先匹配文字，再匹配检测框。
- 按文字分组，同文字的检测框为一组。
- 组内匹配顺序：
  1. 正确：中心点误差在位置容差范围内（阈值 = √(容差X² + 容差Y²)），匹配并消耗该检测框。
  2. 偏差：与模版有边界框重叠但超出误差范围，标记偏差并消耗。
  3. 组内误判：剩余检测框与模版框存在边界框重叠，标记为误判并消耗双方。
  4. 多：剩余检测框标记为多余。
  5. 缺：剩余模版框标记为缺失。
- 跨组误判：所有文字组处理完后，将不同组间"多(过检)"与"缺(漏检)"中边界框重叠的配对合并为误判，并从各自组中移除。
- 匹配成功条件：漏检=0 且 过检=0 且 误判=0；偏差不影响匹配结果（不计入 NG）。
- 匹配分数计算：`Score = max(0, 正确数/模版总数 - 偏差×0.1(上限0.3) - 过检×0.15(上限0.4) - 漏检×0.2(上限0.5) - 误判×0.5(上限0.8))`。
- 支持位置容差、尺寸容差、置信度阈值、文本相似度阈值、最小匹配分数等配置。
- 匹配结果可视化颜色规范：
  - 正确：检测框绿色(50,205,50)，文字绿色。
  - 偏差：模版框黄色虚线(255,255,0, DashOffset=3)，检测框黄色，文字绿色。
  - 误判：检测框红色(255,0,0)，文字标签显示"[NG]，模型：{检测文字}，模版：{模版文字}"。
  - 多：检测框红色(255,0,0)，文字红色，标签前缀"[多]"。
  - 缺：模版框紫色虚线(128,0,128, DashOffset=0)，模版文字紫色，标签前缀"[缺]"。
  - 绘制顺序：正确 → 偏差(模版虚线+检测框) → 误判(带标签) → 过检 → 漏检模版（最后绘制确保不被覆盖）。

#### 5.7.1 模版匹配结果字段
- `ocr_results[]`：`text/x/y/width/height/confidence/recognition_time/match_status`，`match_status` 取值为 `Correct/PositionDeviation/OverDetection/MissedDetection/Misjudgment`。
- `missing_template_items[]`：缺失的模版项，字段 `text/x/y/width/height/status`，`status` 固定为 `missing`。
- `deviation_template_items[]`：偏差模版项，用于绘制模版虚线框，字段 `text/x/y/width/height`。
- `misjudgment_pairs[]`：误判配对，字段 `d_text/d_x/d_y/d_w/d_h` 与 `t_text/t_x/t_y/t_w/t_h`。
- `template_match_info`：`template_name/is_match/match_score/perfect_matches/position_deviations/over_detections/missing_components/misjudgments`，必要时可附加 `error_reason`。

### 5.8 缺陷检测与后处理
- 支持缺陷检测模型输出缺陷位置。
- 支持缺陷大小阈值：最小外接矩形长、宽、面积、分数阈值。
- 支持缝隙检测阈值：长度与宽度超阈值判为 NG。

### 5.9 结果判定与汇总
- 内部判定（ok_internal）用于 UI 展示、存图与统计。
- 写回判定（ok_send）用于 PLC 输出。
- 无产品判定与无条码判定可配置 OK/NG。
- 无条码优先级高于无产品。
- 空跑模式仅影响对外写回与数据归档，不改变内部判定逻辑。
- 汇总规则：任一位置 NG → 总结果 NG；否则 OK。
- 首个 NG 原因需记录到结果数据与 CSV；提取优先级：ErrorMessage → 按位置顺序遍历（pipeline_summary.first_ng_reason → post_processing_statistics.image_ng_reason → 模版匹配不通过时按"缺→多→误判"顺序取首条）。
- 任务级结果聚合（WorkflowResult）：包含 StartTime（时间锚点）、BarcodeText、ProductType、PositionStatuses（各位置 OK/NG/-）、ModularResults（各位置 JObject）、OverallOk、ErrorMessage。

### 5.10 PLC 通信
- 支持 Modbus TCP/RTU 与 FINS/UDP。
- 配置内容包括：连接参数、设备地址、寄存器地址与数量、OK/NG 发送值、应答值与超时。
- 支持运动控制寄存器与指令：速度、目标位置、回零、停止、拍照前等待时间；支持读取当前位置并显示。
- OK/NG 写回采用“写入→读取确认”的时序：读到应答值完成，读到写入值继续等待，读到其他值则重发，超时判定失败。
- 支持拍照信号寄存器监听。
- 支持读码器寄存器读取条码。
- 支持测试连接、测试发送 OK/NG、读取寄存器等操作。

### 5.11 数据存储与追溯
- 图像保存
  - 支持 OK/NG 独立开关与格式设置（JPG/BMP/PNG）。
  - JPG 支持压缩质量设置与文件大小估算。
  - 文件结构：`{根目录}/{日期}/{OK|NG}/{日期_型号或空跑}/{位置}/`
  - 文件命名：`{位置}{位置}_{型号}_{OK|NG}_{日期}_{时间}.{扩展名}`
  - 同目录生成可视化结果图：`{原文件名}_vis.jpg`
- 结果 JSON 保存
  - 与图像同目录存储，命名为 `_result.json`。
  - 记录时间、条码、产品型号与模块结果。
- CSV 记录
  - 每次 RunOnce 在所有位置结果汇总后写入一条记录，避免重复写入。
  - 字段：时间、条码、型号、位置列表、总结果、原因（位置列表按配置顺序展开）。
  - 条码字段在非空时加前缀 `C`。
  - 总结果为 OK 时清空原因字段。
  - 空跑模式下若原结果为 NG，则总结果记为 OK，原因附加"空跑模式"。
- 日志与存储预警
  - 存储空间 90%、95%、99% 分级预警。
  - 日志支持文件与控制台输出、异步写入、文件轮转。

#### 5.11.1 JSON 结果 schema
- 时间基准：同一产品以本次任务起始时间生成 `dateStr=yyyyMMdd`、`timeStr=HHmmss`，图像/JSON/CSV 使用同一锚点。
- 文件路径与命名：`{根目录}/{日期}/{OK|NG}/{日期_型号或空跑}/{位置}/{位置}{位置}_{型号}_{OK|NG}_{日期}_{时间}_result.json`
- 根字段：
  - `capture_time`：`"yyyyMMdd HHmmss"`
  - `barcode_text`：条码原文，无条码时为空字符串
  - `product_type`：产品型号，空/非法时写 `Unknown`
  - `modular_results`：按位置聚合的模块结果对象，键为位置标识
- `modular_results.{pos}` 常见字段：`sample_results/module_outputs/ocr_results/template_match_info`（结构详见 5.5.1 与 5.7.1）。

#### 5.11.2 JSON 样例
{
  "capture_time": "20250205 101530",
  "barcode_text": "BARCODE123",
  "product_type": "MODEL_X",
  "modular_results": {
    "P01": {
      "ocr_results": [
        { "text": "ABC", "x": 10, "y": 20, "width": 80, "height": 20, "confidence": 0.98, "match_status": "Correct" }
      ],
      "template_match_info": { "template_name": "MODEL_X_P01", "is_match": true, "match_score": 1.0 }
    }
  }
}

#### 5.11.3 CSV 记录 schema
- 文件路径与命名：`{根目录}/{日期}.csv`，首行表头为 `时间,条码,型号,{位置列表},总结果,原因`
- 字段含义：`时间/条码/型号/{位置列表}/总结果/原因`
- 条码规则：条码非空时写入 `C{barcode}`，为空则留空
- 编码与转义：按系统默认编码写入；逗号/引号/换行需按 CSV 规则转义
- 总结果：OK/NG；空跑模式下若原结果为 NG 则改写为 OK 并在原因中追加“空跑模式”

#### 5.11.4 CSV 样例
时间,条码,型号,P01,P02,总结果,原因
20250205 101530,C1234567890,MODEL_X,OK,NG,NG,缺：ABC

#### 5.11.5 schema 与样例用途
- schema 用于对接协议、解析校验与验收标准，保证上下游对字段含义一致。
- 样例用于联调、测试数据回放与问题定位，便于快速验证读写与展示逻辑。

### 5.12 UI 操作与展示
- 主界面
  - 多路相机画面按画面分割布局显示。
  - 总结果显示、生产数量、OK/NG 数量、良率统计。
  - 工作流程步骤实时显示。
  - 状态指示：相机、模型、Modbus、读码器、API、各位置结果、模版、总结果、当前位置/运动状态。
  - 图像显示支持缩放、拖拽平移、右键复位视图，可切换可视化叠加（快捷键 V）。
  - 操作按钮：创建模版、调试、设置、拍照、走料、空跑模式。
- 画面分割管理
  - 支持 2x2/3x3/4x4 网格分割。
  - 网格单元可合并/拆分，合并区域必须为矩形。
  - 画面区域可绑定相机视图，未绑定区域为空。
  - 支持布局新增、删除与保存。
- 设置界面
  - 通用：空跑模式、无产品/无条码处理、开机自启动、Unknown 历史策略。
  - 相机：设备选择、触发模式、旋转角度、测试图片路径/目录、离线循环与间隔。
  - 读码器：真实/测试/Modbus、设备选择与测试。
  - 推理：缝隙阈值、位置容差、流程 JSON、模型路径覆盖。
  - 模型：按位置配置模块链路与模型路径。
  - 存图：路径、OK/NG 选项、格式与压缩、JSON 保存。
  - PLC：协议、连接参数、寄存器、发送值、拍照信号监听、运动控制参数。
  - 条码 API：启用开关、URL、超时、测试查询。
  - 测试：测试图片与测试条码，支持 PLC 连接/发送/读寄存器测试。
  - 日志：日志输出、轮转策略、记录器级别与导入导出。
  - 设置修改后需提示重新初始化相关设备与流程。
- 流程图编辑界面
  - 支持主流程图和推理子图两级编辑，共用同一套编辑器框架。
  - 主流程编辑器：可拖拽触发、相机、读码、推理子图、判定、输出等全部主流程模块。
  - 推理子图编辑器：从主流程的 `inference/subgraph` 节点双击进入，编辑推理链路模块。
  - 拖拽模块与连线，配置节点参数并生成流程 JSON。
  - 打开现有 JSON、保存/另存与只读预览，保存前必须校验。
- 模版管理界面
  - 模版列表、模版详情、OCR 信息展示。
  - 从本地图片推理、加载当前结果、删除/保存模版。
  - 选择相机位置生成与管理模版。
- 调试界面
  - 设备初始化状态查看。
  - 模型实时图像与 JSON 结果显示。
  - 手动加载图片推理。
  - 相机单独拍照测试。
  - Modbus 通信日志与发送/读取测试。
  - JSON 详情查看与复制。
流程图与模块化编排详见 `流程图.md`。

### 5.13 测试与模拟规范
- Test 相机：支持单图或图片目录顺序读取，可配置循环与间隔；保持旋转配置一致。
- Test 读码器：使用设置中的测试条码，支持返回无条码。
- 提供存图链路测试（测试保存）用于验证保存路径、权限与格式。
- Modbus TCP 模拟器：寄存器映射 4110 OK/NG 写回、4111 拍照信号、4116 条码（ASCII 高字节在前，10 个寄存器），收到 1/2 后回写 3 作为应答。

## 6. 约束与容错
- 模型、相机、PLC 未就绪时阻止运行或给出提示。
- 多相机采集必须串行以保证传输稳定性。
- API 异常或超时需自动降级为本地映射。
- 存储空间不足需告警但不中断主流程。
- 任一模块异常需进入错误处理流程并可恢复至 Ready 状态。
- 离线/测试模式下允许无 PLC/串口设备。
- 全局未处理异常需弹窗提示并记录日志，避免程序崩溃。