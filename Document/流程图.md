## 流程图与运行关系
- 流程图是单次任务（RunOnce）的执行图，图内不自循环。
- 流程图分两级：**主流程图**和**推理子图**，均由流程图编辑器拖拽生成 JSON。
- 主流程图包含触发、采集、读码、推理子图、判定、输出等全部节点类型，是运行时的入口。
- 推理子图仅包含 AI 推理链路模块（预处理/模型/后处理/可视化等），由主流程中的 `inference/subgraph` 节点引用。
- 运行时先加载主流程 JSON，遇到 `inference/subgraph` 节点时加载并执行其引用的推理子图 JSON。
- 必须包含唯一 Trigger 节点作为入口，至少包含一个 Output 节点用于结果输出。
- 允许分支与汇聚，禁止环路。
- 设备与通信的具体连接参数由设置界面配置并保存，流程图节点通过位置标识等引用这些配置。

## JSON流程图编辑器（C#）
- 目标：通过拖拽模块与连线生成流程 JSON，并与运行时完全一致。
- 基本操作：新建/打开/保存/另存；撤销/重做；缩放/平移；对齐/分布；复制/删除/禁用节点。
- 模块定义与 JSON 分离：JSON 只保存节点实例与连线，不重复端口与属性规范。
- 属性面板：按模块 properties 提供编辑项，支持枚举、范围、路径选择与实时校验。
- 保存行为：保存前必须校验，失败则禁止生成 JSON。
- 编辑器支持两级编辑，共用同一套 JSON 结构（nodes/edges/meta/ui），但模块库和校验规则不同：

### 主流程编辑器
- 模块库包含本文件定义的全部主流程节点类型。
- `inference/subgraph` 节点可双击打开其引用的推理子图 JSON 进入推理子图编辑器。
- 主流程模块库：
  - 触发：trigger/{proto}_*
  - 输入：input/{proto}_*
  - 采集：Camera、code_reader
  - 解析：product_type/resolve
  - 模版：template/load、template/create、template/update、template/delete、template/enable
  - 推理：inference/subgraph（双击打开推理子图编辑器）
  - 后处理：post_processing/defect_size_filter、post_processing/gap_threshold
  - 匹配：template/match
  - 汇总：result/merge_positions
  - 判定：decision/no_product_result、decision/no_barcode_result、decision/force_ok
  - 输出：output/modbus_write_block、output/save_image、output/save_json、output/save_csv、output/save_visualization、output/log_record
- 校验规则：
  - Trigger 必须唯一
  - 至少有一个 output/* 节点
  - Camera 的 position 不能重复
  - inference/subgraph 必须引用有效的推理子图 JSON
  - 端口类型必须匹配；输入端仅允许单连；必填输入必须有连接；图内无环

### 推理子图编辑器
- 从主流程编辑器双击 `inference/subgraph` 节点进入，编辑完成后保存并返回。
- 模块库仅包含推理链路模块：
  - 输入：input/image（图像）、input/build_results（构建结果）
  - 预处理：pre_process/coordinate_crop（固定裁剪）、pre_process/sliding_window（滑窗裁剪）、pre_process/sliding_merge（滑窗结果合并）
  - 模型：model/cls（图像分类）、model/det（目标检测）、model/instance_seg（实例分割）、model/semantic_seg（语义分割）、model/ocr（OCR）、model/rotated_bbox（旋转框）、model/yolo_rknn_det（YOLO(RKNN) 检测）
  - 后处理：post_process/mask_to_rbox（掩码转最小外接矩）、post_process/rbox_angle_correction（旋转框角度分类矫正）、post_process/merge_results（结果合并）、post_process/result_filter（结果筛选）、post_process/result_filter_region（结果过滤（区域））、post_process/result_filter_region_global（结果过滤（区域-全局））、post_process/result_filter_advanced（结果过滤（高级））、post_process/count_results（统计结果个数）、post_process/text_replacement（文本替换）、post_process/rbox_correction（旋转框矫正）、post_process/label_count_filter（标签种类统计）
  - 其他：features/image_generation（生成裁剪）、features/logic_combination（逻辑组合）、features/image_rotate_by_cls（分类矫正）、features/image_flip（镜像翻转）、features/stroke_to_points（笔划转点）、features/template_from_results（结果转模板）、features/template_save（保存模板）、features/template_load（读取模板）、features/template_match（模板匹配）、features/printed_template_match（印刷品模版匹配）、features/assert_result_format（结果格式校验）
  - 输出：output/visualize（原图可视化）、output/visualize_local（局部可视化）、output/preview（预览）、output/text_preview（文本预览）、output/save_image（保存图像）、output/save_text（保存文本）、output/return_json（返回前端JSON）
- 校验规则：端口类型必须匹配；输入端仅允许单连；必填输入必须有连接；图内无环。

## 流程 JSON 结构
- 顶层字段：schema_version、name、description、nodes、edges、meta、ui。
- meta：创建时间、更新时间、作者、备注等（用于追溯）。
- nodes：
  - id：全局唯一且稳定。
  - type：模块类型（如 trigger/modbus_poll、vision/detection）。
  - name：显示名。
  - enabled：启用开关。
  - properties：模块参数，与下文模块定义一致。
  - inputs/outputs：端口清单，包含 name、data_type、required（输入端）。
  - ui：x、y、group 等布局信息。
- edges：
  - id：全局唯一。
  - from：{ node_id, port_name }
  - to：{ node_id, port_name }

## 执行语义
- 节点按数据驱动执行，输入齐备即可运行，同一 RunOnce 中每个节点最多执行一次。
- 相机采集必须串行（按配置顺序），推理与后处理可并行。
- result/merge_positions 等汇总节点需等待所有必需输入到齐后执行。
- 节点失败需写入 success=false，并在 result_chan 中记录 code/text，最终仍输出可追溯的结果结构。

### 采集与推理的流水线调度
- 约束：多相机共享网络带宽，同时取图会丢包，因此取图必须串行；推理使用 GPU/CPU 计算资源，可并行。
- 策略：**取图串行、推理并行、流水线重叠**。每个相机取图完成后立即启动该位置的推理任务（不等待推理结果），然后继续下一个相机的取图，所有推理任务并行执行，最后等待全部推理完成。
- 采集顺序：按配置中的相机位置列表顺序遍历，位置数量不固定。
- 条码与模版：读码→条码处理→模版加载作为独立并行任务，与取图+推理的流水线同时执行。
- 时间线示意（以 3 路相机为例）：
```
Camera_1:  [===取图===]
Camera_2:              [===取图===]
Camera_3:                          [===取图===]
Infer_1:               [===========推理===========]
Infer_2:                           [===========推理===========]
Infer_3:                                       [===========推理===========]
Barcode:   [==读码==条码处理==模版加载==]              ← 与取图+推理并行
```

## 数据载体
- image_chan：Mat，BGR 格式；模型推理阶段临时转 RGB，推理后回到 BGR。
- result_chan：JSON 对象，包含 meta 与模块结果集合。
- 模块结果必须以 node_id 作为键写入，避免覆盖其他模块字段。

## 节点角色
- Trigger：产生任务启动信号。
- Input：产生本次任务输入数据（文本/数值/字节块）。
- Camera：拍照/取图，输出 image_chan + result_chan。
- Vision：预处理/推理/后处理。
- Template：模版管理与匹配。
- Decision：输出 ok/code/text 等标量。
- Output：写回 PLC/网络/串口/落盘。

## 端口协议
- 通道端口：image_chan、result_chan。
- 标量端口：bool / int / string / bytes。
- 标准标量名：triggered、sequence、payload、ok_internal、ok_send、code、text。

## trigger/{proto}_*
- 输入：无
- 输出：triggered(bool), sequence(int), payload(string 可选)
- properties:
    proto: modbus / fins / tcp / serial / software
    signal_address(modbus/fins): 触发寄存器地址
    poll_ms: 轮询间隔
    edge: rising / falling
    listen_port(tcp): 监听端口
    com_name(serial): 串口名
    frame_format: 帧格式
    interval_ms(software): 定时触发间隔

## input/{proto}_*
- 输入：triggered
- 输出：payload(string 或 bytes), success(bool)
- properties:
    proto: modbus / fins / tcp / serial / software
    start_address(modbus/fins): 起始寄存器
    count(modbus/fins): 寄存器数量
    byte_order: 按读寄存器拼接后的字节顺序索引，长度=2*count，与相机数量无关（例：count=2 即 4 字节，可为 0-1-2-3 或 1-0-3-2）
    encoding: ascii / utf8 / hex
    listen_port(tcp): 监听端口
    com_name(serial): 串口名
    baud_rate(serial): 波特率
    default_payload(software): 默认数据

## Camera
- 输入：triggered
- 输出：image_chan, result_chan
- properties:
    mode: Real / Test
    device_config(Real): 保存 DeviceInfoWrapper JSON
    image(Test): 图片文件或目录路径（目录按文件名顺序读取）
    loop(Test): 是否循环
    interval_ms(Test): 采集间隔
    rotation: 0/90/180/270
    position: 位置标识（来自相机配置列表，数量不限定）
    trigger_mode: SoftTrigger / HardTrigger

## code_reader
- 输入：triggered
- 输出：code_text(string), has_code(bool)
- properties:
    mode: Real / Test / Modbus
    device_config(Real): 设备配置
    test_code(Test): 测试条码
    return_no_barcode(Test): 返回无条码
    register_address(Modbus): 条码寄存器起始地址
    register_count(Modbus): 寄存器数量
    trigger_mode: SoftTrigger / Continuous

## product_type/resolve
- 输入：code_text(string)
- 输出：product_type(string), success(bool)
- properties:
    use_api: true / false
    api_url: 条码查询地址
    timeout_sec: 超时秒数
    local_map: 本地条码映射
    unknown_value: Unknown

## template/load
- 输入：product_type(string), position(string)
- 输出：template, has_template(bool)
- properties:
    templates_path: 模版根目录
    allow_historical_unknown_templates: true / false

## template/create
- 输入：image_chan, result_chan, product_type(string), position(string)
- 输出：template_id(string), template
- properties:
    name_rule: 命名规则
    save_image: true / false
    save_path: 保存目录

## template/update
- 输入：template_id(string), template(可选), image_chan(可选), result_chan(可选)
- 输出：success(bool)
- properties:
    update_image: true / false

## template/delete
- 输入：template_id(string)
- 输出：success(bool)

## template/enable
- 输入：template_id(string), enabled(bool)
- 输出：success(bool)

## inference/subgraph
- 作用：引用并运行一个推理子图 JSON，内部模块由该 JSON 定义（检测/OCR/分类/分割/后处理等）。
- 输入：image_chan, result_chan(可选), position(string 可选)
- 输出：image_chan, result_chan
- properties:
    subgraph_path: 推理子图 JSON 文件路径（在主流程编辑器中双击此节点可打开该 JSON 进入推理子图编辑器）
- 运行约定：
  - 运行时加载 subgraph_path 指定的推理子图 JSON，执行完后将 image_chan/result_chan 返回主流程。
  - 推理子图仅负责推理链路，不包含 Trigger/Camera/PLC/Decision 等主流程节点。
  - 以子图 JSON 中的 nodes/edges 为执行依据，节点输入齐备即可运行。
  - image_chan 输入为 BGR，模型推理节点内部转 RGB，输出回 BGR。
  - result_chan 按 node_id 聚合结果，避免覆盖其他模块字段。
  - 模型路径与阈值允许被设置覆盖。
- 实际执行桥梁（DlcvFlowRunner）：
  - 加载 JSON 并解析 nodes 数组，深拷贝后用于执行。
  - 根据面别/位置注入属性：如 `features/printed_template_match` 节点注入 `check_position`（是否检查位置）和 `product_type`（产品型号）。
  - 应用设置 Overrides：按"面别→节点id→字段"三级结构覆盖 JSON 中的 properties（如模型路径）。
  - 构建 ExecutionContext 并注入：`frontend_image_mat`（图像 Mat）、`templates_dir`（模版目录）、`face`（面别标识）、`barcode_text`（条码）。
  - 通过 GraphExecutor 执行，收集结果：从 `output/visualize` 节点取可视化 overlay，从 `features/printed_template_match` 取 ok/detail/template_list。

## features/printed_template_match（推理子图模块）
- 作用：在推理子图内执行印刷品模版匹配，根据推理结果与已有模版对比判定 OK/NG。
- 输入：图像（通过 ExecutionContext 注入）、推理结果链路上游输出
- 输出：ok(bool, 端口0)、detail(string, 端口2)、template_list
- properties:
    check_position: true / false（是否检查位置匹配，由 DlcvFlowRunner 按面别注入）
    product_type: 产品型号（由 DlcvFlowRunner 注入，用于按型号查找模版）
- 行为：加载模版目录下对应型号的模版文件，与推理结果执行匹配，输出匹配判定与详情 JSON。

## post_processing/defect_size_filter
- 输入：result_chan
- 输出：result_chan, ok_raw(bool)
- properties:
    min_rect_length: 最小外接矩形长
    min_rect_width: 最小外接矩形宽
    min_area: 最小面积
    min_score: 最小分数

## post_processing/gap_threshold
- 输入：result_chan
- 输出：result_chan, ok_raw(bool)
- properties:
    gap_length_threshold: 缝隙长度阈值
    gap_width_threshold: 缝隙宽度阈值

## template/match
- 输入：template, result_chan
- 输出：match_result, ok_raw(bool), match_summary
- properties:
    position_tolerance_x
    position_tolerance_y
    size_tolerance
    min_confidence_threshold
    text_similarity_threshold
    min_match_score
    strict_text_matching
    enable_position_tolerance
    enable_text_similarity_matching

## result/merge_positions
- 输入：ok_raw[positions], result_chan[positions]
- 输出：position_statuses, overall_ok(bool), first_ng_reason(string)
- properties:
    ng_priority_order: 位置标识列表
    any_ng_is_ng: true

## Decision
约定：
- ok_internal：内部判定（用于 UI/存图/统计等）
- ok_send：写回设备用判定

decision/no_product_result
- 输入：ok_in(bool), has_item(bool)
- properties：missing=OK|NG
- 输出：ok
- 规则：has_item=false -> ok=missing；否则 ok=ok_in
- PrintMatch：仅在模版匹配主位置使用（has_item 可由“是否检测到无产品”得到）

decision/no_barcode_result
- 输入：ok_in(bool), has_code(bool)
- properties：missing=OK|NG
- 输出：ok
- 规则：has_code=false -> ok=missing；否则 ok=ok_in
- PrintMatch：优先级高于无产品（无条码时内部判定直接按此配置）

decision/force_ok（空跑，仅影响写回）
- 输入：ok_in(bool), success_in(bool 可选，默认 true)
- 输出：ok_send(bool)
- 规则：空跑开启 -> ok_send=true；否则 ok_send=(ok_in && success_in)
- PrintMatch：不修改 ok_internal，只影响写回 PLC

链路
- 内部判定：ok_raw -> no_product_result -> no_barcode_result -> ok_internal
- 写回输出：ok_internal (+ success) -> force_ok -> ok_send -> output/*

## output/modbus_write_block
- 输入：ok_send(bool), code(int 可选), text(string 可选), sequence(int 可选)
- 输出：success(bool), ack(bool)
- properties:
    connection_profile: 连接配置
    start_address: 结果寄存器地址
    count: 寄存器数量
    ok_value: OK 发送值
    ng_value: NG 发送值
    ack_value: 应答值
    timeout_ms: 超时
    retry_ms: 重试间隔

## output/save_image
- 输入：image_chan, overall_ok(bool), product_type(string), position(string), detection_result
- 输出：image_path(string), file_size(long)
- properties:
    save_root: 存储根路径
    save_ok_images: true / false
    save_ng_images: true / false
    ok_format: JPG / PNG / BMP
    ng_format: JPG / PNG / BMP
    jpg_quality: 1-100

## output/save_json
- 输入：detection_result, overall_ok(bool), product_type(string), position(string)
- 输出：json_path(string)
- properties:
    save_root: 存储根路径
    save_ok_results: true / false
    save_ng_results: true / false

## output/save_csv
- 输入：detection_result, overall_ok(bool), product_type(string), position_statuses, first_ng_reason
- 输出：csv_path(string)
- properties:
    save_root: 存储根路径
    barcode_prefix: C
    fields: 时间/条码/型号/{位置列表}/总结果/原因

## output/save_visualization
- 输入：image_chan, result_chan
- 输出：vis_path(string)
- properties:
    suffix: _vis
    jpg_quality: 1-100

## output/log_record
- 输入：level(string), text(string), context(object 可选)
- 输出：无
- properties:
    enable_console: true / false
    enable_file: true / false
    enable_async: true / false
    flush_interval_sec
    max_file_size_mb
    max_file_count

## 数据与文件规范
- 时间锚定：同一产品的图像、JSON 与 CSV 使用统一时间基准。
- JSON 结构要求：包含采集时间、条码、产品型号与模块结果字段。
- CSV 编码：UTF-8 BOM 或系统默认编码，需支持字段转义。

## 图像格式约定
- pipeline 中间 Mat：BGR。
- 模型推理：RGB。
- 图像存储：BGR。
- 图像显示：BGR 或 BGRA。
