# 底层库与移植说明

新 OpenIVS 基于原 OpenIVS 仓库的底层库开发，缺失的能力从 PrintMatch 移植。

## 项目架构

```
OpenIVS.sln （新建解决方案）
├── CameraManager/          ← 已有，相机控制
├── DlcvCsharpApi/          ← 已有，AI 推理引擎 + 流程图模块
├── ImageViewer/            ← 需移植 WPF 版替换 WinForms 版
├── ModbusApi/              ← 已有，需移植 TCP/异步/重连增强
├── SimpleLogger/           ← 已有，需移植高级日志能力
├── DlcvDvpHttpApi/         ← 已有，DVP 服务推理
├── DlcvHttpApi/            ← 已有，通用 HTTP API
├── CodeReader/             ← 需从 PrintMatch 移植
├── DataModels/             ← 需从 PrintMatch 移植精简
├── InferenceEngine/        ← 需从 PrintMatch 移植
├── TemplateEngine/         ← 需从 PrintMatch 移植
└── OpenIVSUI/              ← 新建，WPF 主程序
```

## 已有底层库

| 项目 | 命名空间 | 说明 |
|------|---------|------|
| CameraManager | DLCV.Camera | 相机控制，海康 MVS SDK，含 DeviceInfoWrapper |
| DlcvCsharpApi | dlcv_infer_csharp + DlcvModules | AI 推理引擎（Model/DvsModel/OcrWithDetModel）+ 流程图全部模块（MainProcess/FlowGraphModel/Models/Features/Templates/Visualize/Inputs/Outputs 等） |
| ModbusApi | DLCV | Modbus 通信，EasyModbus 封装，串口 RTU |
| SimpleLogger | DLCV | 简易日志，文件 + 控制台输出 |
| DlcvDvpHttpApi | DlcvDvpHttpApi | DVP 服务推理 HTTP API |
| DlcvHttpApi | DLCV | 通用 HTTP API |

## 需从 PrintMatch 移植的能力

### 1. ICamera 接口（增强 CameraManager）
- 来源：PrintMatch `DLCV.Camera` 的 ICamera.cs
- 原因：OpenIVS 的 CameraManager 没有接口抽象，无法支持 TestCamera 模拟设备
- 移植内容：ICamera 接口定义、TestCamera 实现、CameraUtils 工具类
- 目标：在 CameraManager 项目中添加接口，保持原有实现兼容

### 2. WPF 图像显示控件（替换 ImageViewer）
- 来源：PrintMatch `DLCV.ImageViewer` 的 ImageViewerControl.cs + IImageViewer.cs
- 原因：OpenIVS 的 ImageViewer 是 WinForms Panel（继承 System.Windows.Forms.Panel），新项目是 WPF
- 移植内容：WPF UserControl 版图像显示控件，支持缩放/拖拽/复位/可视化叠加
- 目标：替换为 WPF 版 ImageViewer 项目

### 3. Modbus TCP + 异步 + 自动重连（增强 ModbusApi）
- 来源：PrintMatch `DLCV.ModbusApi` 的增强部分
- 原因：OpenIVS 的 ModbusApi 仅支持同步串口 RTU，缺少 TCP 连接、异步调用、自动重连
- 移植内容：TCP 连接方式、异步读写方法（ReadHoldingRegistersAsync 等）、断线重连机制、数据传输事件
- 目标：在 ModbusApi 项目中增加 TCP 和异步支持

### 4. 高级日志（增强 SimpleLogger）
- 来源：PrintMatch `DLCV.Logging`
- 原因：OpenIVS 的 SimpleLogger 功能简单，缺少异步写入、文件轮转、UI 回调、多级别输出
- 移植内容：异步日志写入、文件大小轮转、UI 日志回调接口、日志导入导出
- 目标：增强 SimpleLogger 或替换为新的 Logging 项目

### 5. 读码器控制（新建 CodeReader）
- 来源：PrintMatch `PrintMatch.CodeReader` + `PrintMatchUI.Services.ModbusCodeReader`
- 原因：OpenIVS 没有读码器库
- 移植内容：ICodeReader 接口、真实读码器实现（CodeReader.cs）、TestCodeReader、ModbusCodeReader（基于 ModbusApi 的读码实现，从 PrintMatchUI 移入）、CodeReaderUtils 工具类
- 目标：新建 CodeReader 项目

### 6. 数据模型（新建 DataModels）
- 来源：PrintMatch `PrintMatch.DataModels`
- 原因：OpenIVS 没有统一的数据模型定义
- 移植内容：
  - 枚举：MatchStatus（Correct/PositionDeviation/OverDetection/MissedDetection/Misjudgment）、ImageFormat、ImageSaveResult
  - 模型：Template、OCRResult、DetectionResult、TemplateMatchResult、MatchingConfiguration、ImageSaveConfig
  - 流程：FaceRunResult（单面运行结果）、FlowJsonConfig（四面流程 JSON 配置，含 Overrides）
  - 注意：PrintMatch 使用固定的 CameraPosition 枚举(A/B/C/D)，新 OpenIVS 改为字符串标识的动态位置，移植时需将枚举改为字符串键
- 目标：新建 DataModels 项目，按新 OpenIVS 需求精简

### 7. 推理引擎封装（新建 InferenceEngine）
- 来源：PrintMatch `PrintMatch.InferenceEngine`
- 原因：OpenIVS 的 DlcvCsharpApi 只有底层推理接口，缺少业务层封装
- 移植内容：
  - IDataProcessingModule 接口、ProcessingInput/ProcessingOutput 数据结构、ModuleConfig 配置
  - ProcessingPipeline 管道管理（模块级联、角色标记 Template/Defect、pipeline_summary 汇总）
  - DlcvFlowRunner：基于 DlcvModules.GraphExecutor 的推理子图 JSON 运行封装，支持面别属性注入（check_position/product_type）、设置 Overrides 覆盖（模型路径等）、ExecutionContext 注入（图像/模版目录/面别/条码）、结果收集（可视化 overlay、ok/ng 判定、detail JSON）
  - 具体模块：DetectionModule、OCRModule、ClassificationModule、SegmentationModule、DefectDetectionModule、PostProcessingModule 等
- 目标：新建 InferenceEngine 项目，封装模型加载/推理/模块级联与 JSON 流程运行

### 8. 模版匹配引擎（新建 TemplateEngine）
- 来源：PrintMatch `PrintMatch.TemplateEngine`
- 原因：OpenIVS 没有模版匹配能力（DlcvCsharpApi 中的 Templates.cs 仅是流程图模块级实现）
- 移植内容：
  - ITemplateEngine 接口、ITemplateManager 接口
  - AdvancedTemplateEngine：按文字分组匹配算法（正确/偏差/误判/多/缺）、跨组误判合并、分数计算
  - TemplateManager：模版文件读写、缓存管理、Unknown 策略、TemplateId 生成（安全文件名+位置后缀）
  - FileTemplateEngine：门面类，组合 AdvancedTemplateEngine 与 TemplateManager
  - TemplateMatchHelper：模版匹配门面工具，集中"匹配 + JSON 标注（match_status/missing_template_items/deviation_template_items/misjudgment_pairs/template_match_info）+ NG 原因生成"逻辑
  - TemplateVisualizer：模版匹配结果可视化导出，从 JSON 绘制各状态框到图像并保存为 JPG
  - ExtendedTemplateMatchResult、TextGroupMatchResult、MatchItem 等数据结构
- 目标：新建 TemplateEngine 项目

### 9. 应用层通用服务（移植到 OpenIVSUI 或独立项目）
- 来源：PrintMatchUI.Services
- 原因：以下服务包含通用业务逻辑，需在新项目中复用
- 移植内容：
  - ProductTypeService：条码→型号映射（API 查询 + 本地映射表降级）
  - ImageSaveService：图像保存（路径结构 `日期/OK|NG/日期_型号/位置/`、格式选择、空间检测与分级预警）
  - CsvDetectionLogService：CSV 记录（字段生成、NG 原因提取、空跑处理、转义）
  - WorkflowManager：工作流编排（取图串行+推理并行流水线、条码并行、结果汇总、事件通知）
- 目标：按新架构重构，WorkflowManager 中 PrintMatch 特有的硬编码（A/B/C/D 位置、B 面 CSV 触发等）改为通用逻辑

## 不需要移植的

| 内容 | 原因 |
|------|------|
| 推理子图模块（检测/OCR/分类/分割/后处理/可视化等） | DlcvCsharpApi 中的 DlcvModules 命名空间已包含全部实现 |
| 流程图模型定义 | DlcvCsharpApi 中的 FlowGraphModel.cs 已有 |
| 推理子图执行引擎 | DlcvCsharpApi 中的 MainProcess.cs 已有 |

## 项目结构差异说明

| 差异点 | PrintMatch | OpenIVS | 移植策略 |
|--------|-----------|---------|---------|
| DlcvModules | 独立项目（DlcvModules.csproj） | 合并在 DlcvCsharpApi 中 | 使用 OpenIVS 的合并结构，无需拆分 |
| CameraPosition | 固定枚举 A/B/C/D | 字符串标识，数量不固定 | 将枚举改为字符串键，所有引用处同步修改 |
| 模版匹配 | TemplateEngine 项目 + DlcvModules 中的 printed_template_match | 两处均需保留 | TemplateEngine 用于主流程级匹配，printed_template_match 用于推理子图内匹配 |

## 设置与流程图的分工

| 放在设置界面 | 放在流程图节点属性 |
|-------------|-----------------|
| Modbus 连接参数（IP、端口、协议） | 推理模块链路编排 |
| 相机设备选择 | 每个位置的模型路径 |
| 相机旋转角度 | 推理模块参数（阈值等） |
| 读码器设备选择、类型 | 可视化输出配置 |
| 存图路径、格式、压缩率 | |
| 日志配置 | |
| 条码 API 地址、超时 | |
| 测试图片/条码 | |
| PLC 寄存器地址、发送值 | |
| 拍照信号监听间隔 | |

原则：连接参数、设备选择、全局路径等放设置；推理链路编排、模型参数放流程 JSON。

## 第一版开发策略

- 流程图编辑器和图驱动执行引擎**暂不实现**，后续再加。
- 第一版用代码编排工作流（类似 PrintMatch 的 WorkflowManager），推理子图通过 JSON 配置。
- 底层库移植按需进行：先移植核心依赖（ICamera、WPF ImageViewer、Modbus 增强），再移植业务层（CodeReader、DataModels、InferenceEngine、TemplateEngine）。
